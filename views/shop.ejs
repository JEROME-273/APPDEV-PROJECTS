<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/shop.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <title>AgriEcommerce - Shop</title>
</head>
<body>
    <!-- Header Section -->
    <header class="header">
        <div class="logo">
            <img src="/images/agri_logo.jpeg" alt="AgriEcommerce Logo">
            <h1>AgriEcommerce</h1>
        </div>
        <nav class="navbar">
            <a href="/welcome"><i class="fas fa-home"></i>Home</a>
            <a href="/shop"><i class="fas fa-shopping-cart"></i>Shop</a>
            <a href="/aboutus"><i class="fas fa-info-circle"></i>About Us</a>
            <a href="/contact"><i class="fas fa-envelope"></i>Contact</a>
        </nav>
        <div class="icons">
            <!-- New 'My Shop' Button -->
            <a href="/my-shop" class="my-shop-btn"><i class="fas fa-store"></i>My Shop</a>
            <div class="search-bar">
                <input type="text" placeholder="Search">
                <button type="submit"><i class="fas fa-search"></i></button>
            </div>
            <div class="user-icon" onclick="toggleDropdown(event)">
                <% if (user && user.profile_pic) { %>
                    <img src="/uploads/<%= user.profile_pic %>" alt="User Profile">
                <% } else { %>
                    <img src="/images/default-profile.png" alt="Default Profile">
                <% } %>
            </div>
            <div class="dropdown-menu" id="userDropdown">
                <a href="/profile">User Profile</a>
                <a href="/change-password">Change Password</a>
                <a href="#" onclick="confirmLogout()">Logout</a>
            </div>
            <!-- Cart Icon with Count -->
            <a href="/cart" class="cart-icon">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count"><%= cartCount %></span> <!-- Dynamic cart count -->
            </a>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div>Welcome to Shop</div>
    </section>

    <!-- Products Section -->
<section class="products">
    <h2>All Products:</h2>
    <div class="product-list">
        <% if (products && products.length > 0) { %>
            <% products.forEach(product => { %>
                <div class="product-item">
                    <!-- Shop name and icon -->
                    <div class="shop-header">
                        <div class="shop-icon">
                            <i class="fas fa-store"></i> <!-- Default store icon, can be replaced with custom icon -->
                        </div>
                        <div class="shop-name"><%= product.shopName %></div>
                    </div>

                    <img src="/uploads/<%= product.p_image %>" alt="<%= product.p_name %>">

                    <div class="product-info">
                        <h3><%= product.p_name %></h3>

                        <!-- Product description with toggle button -->
                        <div id="description-<%= product.id %>" class="product-description">
                            <p><%= product.p_description %></p>
                        </div>

                        <button class="toggle-description-btn" data-product-id="<%= product.id %>">
                            Show Description
                        </button>

                        <p>Price: ₱<%= product.p_price %></p>
                        <p>Stock: <%= product.p_quantity %></p>
                    </div>

                    <!-- Add to Cart Button -->
                    <div class="add-to-cart">
                        <button type="button" class="add-to-cart-btn" data-product-id="<%= product.id %>">
                            <i class="fas fa-cart-plus"></i> Add to Cart
                        </button>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <p>No products available in the shop yet. Start adding some products!</p>
        <% } %>
    </div>
</section>



    <!-- Orders Section -->
<section class="orders-section">
    <h2>My Orders</h2>

    <% if (orders && orders.length > 0) { %>
        <% orders.forEach(order => { %>
            <div class="order-card" data-order-id="<%= order.order_id %>">
                <div class="order-header">
                    <h3>Order ID: <%= order.order_id %></h3>
                    <p class="order-date"><i class="fas fa-calendar-alt"></i> <%= new Date(order.created_at).toLocaleString() %></p>
                </div>

                <div class="order-details">
                    <p><strong><i class="fas fa-map-marker-alt"></i> Address:</strong> <%= order.address %></p>
                    <p><strong><i class="fas fa-phone"></i> Contact Number:</strong> <%= order.contact_number %></p>
                    <p><strong><i class="fas fa-credit-card"></i> Payment Method:</strong> <%= order.payment_method %></p>
                    <p><strong><i class="fas fa-tag"></i> Status:</strong> <span class="status <%= order.status.toLowerCase() %>"><%= order.status %></span></p>
                    <p><strong><i class="fas fa-money-bill-wave"></i> Total Amount:</strong> ₱<%= order.total_amount %></p>
                </div>

                <div class="order-products">
                    <h4>Products:</h4>
                    <ul>
                        <% if (order.items && Array.isArray(order.items) && order.items.length > 0) { %>
                            <% order.items.forEach(item => { %>
                                <li class="order-item">
                                    <img src="/uploads/<%= item.product_image.split('/').pop() %>" alt="<%= item.product_name %>">
                                    <div class="product-info">
                                        <p><i class="fas fa-certificate"></i> <%= item.product_name %> (x<%= item.quantity %>)</p>
                                    </div>
                                </li>
                            <% }); %>
                        <% } else { %>
                            <p>No products found in this order.</p>
                        <% } %>
                    </ul>
                </div>                    

                <!-- Order Actions -->
                <div class="order-actions">
                    <% if (order.status === 'pending') { %>
                        <button class="btn-action cancel-order" data-order-id="<%= order.order_id %>"><i class="fas fa-times-circle"></i> Cancel Order</button>
                    <% } else if (order.status === 'confirmed') { %>
                        <button class="btn-action" disabled><i class="fas fa-times-circle"></i> Cancel Order (Confirmed)</button>
                    <% } %>
                    <button class="btn-action track-order"><i class="fas fa-truck"></i> Track Order</button>
                </div>
            </div>
        <% }); %>
    <% } else { %>
        <p>You don't have any orders yet.</p>
    <% } %>
</section>

<!-- Canceled Orders Section -->
<section class="canceled-orders-section">
    <h2>Canceled Orders</h2>

    <% if (canceledOrders && canceledOrders.length > 0) { %>
        <% canceledOrders.forEach(order => { %>
            <div class="canceled-order-card" data-order-id="<%= order.order_id %>">
                <div class="order-header">
                    <h3>Order ID: <%= order.order_id %></h3>
                    <p class="order-date"><i class="fas fa-calendar-alt"></i> <%= new Date(order.created_at).toLocaleString() %></p>
                </div>

                <div class="order-details">
                    <p><strong><i class="fas fa-map-marker-alt"></i> Address:</strong> <%= order.address %></p>
                    <p><strong><i class="fas fa-phone"></i> Contact Number:</strong> <%= order.contact_number %></p>
                    <p><strong><i class="fas fa-credit-card"></i> Payment Method:</strong> <%= order.payment_method %></p>
                    <p><strong><i class="fas fa-tag"></i> Status:</strong> <span class="status canceled">Canceled</span></p>
                    <p><strong><i class="fas fa-money-bill-wave"></i> Total Amount:</strong> ₱<%= order.total_amount %></p>
                </div>

                <div class="order-products">
                    <h4>Products:</h4>
                    <ul>
                        <% if (order.items && Array.isArray(order.items) && order.items.length > 0) { %>
                            <% order.items.forEach(item => { %>
                                <li class="order-item">
                                    <img src="/uploads/<%= item.product_image.split('/').pop() %>" alt="<%= item.product_name %>">
                                    <div class="product-info">
                                        <p><i class="fas fa-certificate"></i> <%= item.product_name %> (x<%= item.quantity %>)</p>
                                    </div>
                                </li>
                            <% }); %>
                        <% } else { %>
                            <p>No products found in this order.</p>
                        <% } %>
                    </ul>
                </div>

                <div class="order-actions">
                    <button class="btn-action" disabled><i class="fas fa-times-circle"></i> Canceled Order</button>
                    <button class="btn-action track-order" disabled><i class="fas fa-truck"></i> Track Order</button>
                </div>
            </div>
        <% }); %>
    <% } else { %>
        <p>You don't have any canceled orders yet.</p>
    <% } %>
</section>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
                      document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                        button.addEventListener('click', async function() {
                            const productId = this.getAttribute('data-product-id');
                            
                            try {
                                // Make the POST request to add the item to the cart
                                const response = await fetch('/cart/add', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ productId: productId })
                                });

                                const data = await response.json();
                                if (response.ok) {
                                    // Update the cart count dynamically
                                    document.getElementById('cart-count').textContent = data.cartCount;

                                    // Show the success message
                                    showMessage('Product added to cart successfully');
                                } else {
                                    console.error('Error:', data.message);  // Handle error message if you want
                                }
                            } catch (error) {
                                console.error('Error adding to cart:', error);
                            }
                        });
                    });

                    // Function to show the success message
                    function showMessage(message) {
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('cart-message');
                        messageElement.textContent = message;

                        // Append the message to the body
                        document.body.appendChild(messageElement);

                        // Show and fade out the message
                        setTimeout(() => {
                            messageElement.style.opacity = 0; // Start fading out
                        }, 2000); // Fade out after 2 seconds

                        // Remove the message after it fades out
                        setTimeout(() => {
                            messageElement.remove();
                        }, 3000); // Remove after 3 seconds to give time for fade out
                    }

                    function cancelOrder(orderId) {
                    const confirmation = confirm("Are you sure you want to cancel this order?");
                    if (!confirmation) {
                        return;
                    }

                    $.ajax({
                        type: 'POST',
                        url: '/order/cancel/' + orderId,
                        data: { orderId: orderId },
                        success: function(response) {
                            alert(response.message);

                            // Remove the canceled order from the active orders section
                            const orderCard = $(`.order-card[data-order-id="${orderId}"]`);
                            orderCard.fadeOut(500, function() {
                                $(this).remove();  // Remove from orders section
                            });

                            // Append the canceled order to the canceled orders section
                            const canceledOrderHTML = `
                                <div class="order canceled">
                                    <h3>Order ID: ${response.orderId}</h3>
                                    <p>Status: <strong>Canceled</strong></p>
                                    <p>Total Amount: ₱${response.totalAmount}</p>
                                    <ul>
                                        ${response.items.map(item => `
                                            <li>
                                                <img src="/uploads/${item.product_image.split('/').pop()}" alt="${item.product_name}" width="50">
                                                ${item.product_name} (x${item.quantity})
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `;

                            // Append to canceled orders list
                            $('.canceled-order-list').append(canceledOrderHTML);

                            // Show canceled orders section if no orders have been canceled yet
                            if ($('.canceled-order-list .order').length > 0) {
                                $('.canceled-orders').show();
                            }

                            // Update order counts
                            updateOrderCounts();
                        },
                        error: function(xhr) {
                            alert(`Error: ${xhr.responseJSON ? xhr.responseJSON.message : 'An error occurred'}`);
                        }
                    });
                }

                function updateOrderCounts() {
                    const activeOrdersCount = $('.order-card').length;
                    const canceledOrdersCount = $('.canceled-order-list .order').length;
                    $('#active-orders-count').text(activeOrdersCount);
                    $('#canceled-orders-count').text(canceledOrdersCount);
                }


                function updateOrderCounts() {
                    const activeOrdersCount = $('.order-card').length;
                    const canceledOrdersCount = $('.canceled-order-list .order').length;
                    $('#active-orders-count').text(activeOrdersCount);
                    $('#canceled-orders-count').text(canceledOrdersCount);
                }

                $(document).ready(function() {
                    // Cancel order click event
                    $('.cancel-order').on('click', function(event) {
                        event.preventDefault();
                        const orderId = $(this).data('order-id');
                        cancelOrder(orderId);
                    });
                });
                    
                        function toggleDropdown(event) {
                            event.stopPropagation();
                            const dropdown = document.getElementById('userDropdown');
                            dropdown.classList.toggle('show');
                        }

                        function confirmLogout() {
                            const confirmation = confirm("Are you sure you want to log out?");
                            if (confirmation) {
                                window.location.href = '/logout'; 
                            }
                        }

                        window.onclick = function(event) {
                            const dropdown = document.getElementById('userDropdown');
                            if (!event.target.matches('.user-icon') && !event.target.closest('.dropdown-menu')) {
                                dropdown.classList.remove('show');
                            }
                        };

                        // JavaScript to handle the button click and toggle description
                document.querySelectorAll('.toggle-description-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const productId = this.getAttribute('data-product-id');
                        toggleDescription(productId);
                    });
                });

                // Function to toggle the description visibility
                function toggleDescription(productId) {
                    const description = document.getElementById('description-' + productId);
                    const btn = document.querySelector(`button[data-product-id="${productId}"]`);

                    if (description.style.display === "none") {
                        description.style.display = "block";
                        btn.textContent = "Hide Description"; // Change button text
                    } else {
                        description.style.display = "none";
                        btn.textContent = "Show Description"; // Change button text
                    }
                }
    </script>
</body>
</html>
