<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AgriEcommerce - Shop</title>
    
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  </head>
  <body>
    <!-- Header Section -->
    <header class="header">
      <div class="logo">
        <img src="/images/agri_logo.jpeg" alt="AgriEcommerce Logo" />
        <h1>AgriEcommerce</h1>
      </div>
      <nav class="navbar">
        <a href="/welcome"><i class="fas fa-home"></i>Home</a>
        <a href="/shop"><i class="fas fa-shopping-cart"></i>Shop</a>
        <a href="/aboutus"><i class="fas fa-info-circle"></i>About Us</a>
        <a href="/news"><i class="fas fa-newspaper"></i>News</a>
        <a href="/contact"><i class="fas fa-envelope"></i>Contact</a>
      </nav>
      <div class="icons">
        <div class="search-bar">
          <input type="text" placeholder="Search" />
          <button type="submit"><i class="fas fa-search"></i></button>
        </div>
        <div class="user-icon" onclick="toggleDropdown(event)">
          <% if (user && user.profile_pic) { %>
          <img src="/uploads/<%= user.profile_pic %>" alt="User Profile" />
          <% } else { %>
          <img src="/images/default-profile.png" alt="Default Profile" />
          <% } %>
        </div>
        <div class="dropdown-menu" id="userDropdown">
          <a href="/profile">User Profile</a>
          <a href="/change-password">Change Password</a>
          <a href="#" onclick="confirmLogout()">Logout</a>
        </div>
        <a href="/cart" class="cart-icon"></a>
      </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
      <div>Welcome to our Shop</div>
    </section>

    <!-- Products Section -->
    <section class="products">
      <% products.forEach(product => { %>
      <div class="product-card">
        <a href="/product/<%= product.id %>">
          <img
            src="<%= product.product_image ? '/uploads/' + product.product_image.split('/').pop() : '/images/default-product-image.jpg' %>"
            alt="<%= product.product_name %>" />
        </a>
        <h3><%= product.product_name %></h3>
        <p>
          Price: ₱<%= (typeof product.price === 'number' ?
          product.price.toFixed(2) : 'N/A') %>
        </p>
        <p>Stocks: <%= product.quantity %></p>
        <button class="add-to-cart" onclick="addToCart('<%= product.id %>')">
          <i class="fas fa-cart-plus"></i> Add to Cart
        </button>
      </div>

      <% }) %>
    </section>

    <!-- View Cart Button -->
    <div style="text-align: center">
      <button class="view-cart-btn" onclick="window.location.href='/cart'">
        <i class="fas fa-shopping-cart"></i> View Cart
      </button>
    </div>

    <!-- Orders Section -->
    <section class="orders-section">
      <h2>My Orders</h2>

      <% if (orders && orders.length > 0) { %> <% orders.forEach(order => { %>
      <div class="order-card" data-order-id="<%= order.order_id %>">
        <div class="order-header">
          <h3>Order ID: <%= order.order_id %></h3>
          <p class="order-date">
            <i class="fas fa-calendar-alt"></i> <%= new
            Date(order.created_at).toLocaleString() %>
          </p>
        </div>

        <div class="order-details">
          <p>
            <strong><i class="fas fa-map-marker-alt"></i> Address:</strong> <%=
            order.address %>
          </p>
          <p>
            <strong><i class="fas fa-phone"></i> Contact Number:</strong> <%=
            order.contact_number %>
          </p>
          <p>
            <strong><i class="fas fa-credit-card"></i> Payment Method:</strong>
            <%= order.payment_method %>
          </p>
          <p>
            <strong><i class="fas fa-tag"></i> Status:</strong>
            <span class="status <%= order.status.toLowerCase() %>"
              ><%= order.status %></span
            >
          </p>
          <p>
            <strong
              ><i class="fas fa-money-bill-wave"></i> Total Amount:</strong
            >
            ₱<%= order.total_amount %>
          </p>
        </div>

        <div class="order-products">
          <h4>Products:</h4>
          <ul>
            <% order.items.forEach(item => { %>
            <li class="order-item">
              <img
                src="/uploads/<%= item.product_image.split('/').pop() %>"
                alt="<%= item.product_name %>" />
              <div class="product-info">
                <p>
                  <i class="fas fa-certificate"></i> <%= item.product_name %>
                  (x<%= item.quantity %>)
                </p>
              </div>
            </li>
            <% }); %>
          </ul>
        </div>

        <!-- Order Actions -->
        <div class="order-actions">
          <% if (order.status === 'pending') { %>
          <button
            class="btn-action cancel-order"
            data-order-id="<%= order.order_id %>">
            <i class="fas fa-times-circle"></i> Cancel Order
          </button>
          <% } else if (order.status === 'confirmed') { %>
          <button class="btn-action" disabled>
            <i class="fas fa-times-circle"></i> Cancel Order (Confirmed)
          </button>
          <% } %>
          <button class="btn-action track-order">
            <i class="fas fa-truck"></i> Track Order
          </button>
        </div>
      </div>
      <% }); %> <% } else { %>
      <p>You don't have any orders yet.</p>
      <% } %>

      <!-- Display Canceled Orders if any -->
      <% if (canceledOrders && canceledOrders.length > 0) { %>
      <div class="canceled-orders">
        <h2>Cancelled Orders</h2>
        <div class="canceled-order-list">
          <% canceledOrders.forEach(function(order) { %>
          <div class="order canceled">
            <h3>Order ID: <%= order.order_id %></h3>
            <p>Status: <strong>Cancelled</strong></p>
            <p>Total Amount: ₱<%= order.total_amount %></p>
            <ul>
              <% order.items.forEach(function(item) { %>
              <li>
                <img
                  src="/uploads/<%= item.product_image.split('/').pop() %>"
                  alt="<%= item.product_name %>"
                  width="50" />
                <%= item.product_name %> (x<%= item.quantity %>)
              </li>
              <% }); %>
            </ul>
          </div>
          <% }); %>
        </div>
      </div>
      <% } %>
    </section>

    <div class="alert" id="cartAlert"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      function cancelOrder(orderId) {
        const confirmation = confirm(
          "Are you sure you want to cancel this order?"
        );
        if (!confirmation) {
          return;
        }

        $.ajax({
          type: "POST",
          url: "/order/cancel/" + orderId,
          data: { orderId: orderId },
          success: function (response) {
            alert(response.message);
            const orderCard = $(`.order-card[data-order-id="${orderId}"]`);
            orderCard.fadeOut(500, function () {
              $(this).remove();
            });
            const canceledOrderHTML = `
                <div class="order canceled">
                    <h3>Order ID: ${response.orderId}</h3>
                    <p>Status: <strong>Cancelled</strong></p>
                    <p>Total: ₱${response.totalAmount}</p>
                    <ul>
                        ${response.items
                          .map(
                            (item) => `
                            <li>
                                <img src="/uploads/${item.product_image
                                  .split("/")
                                  .pop()}" alt="${
                              item.product_name
                            }" width="50">
                                ${item.product_name} (x${item.quantity})
                            </li>
                        `
                          )
                          .join("")}
                    </ul>
                </div>
            `;
            $(".canceled-order-list").append(canceledOrderHTML);
            if ($(".canceled-order-list .order").length > 0) {
              $(".canceled-orders").show();
            }

            updateOrderCounts();
          },
          error: function (xhr) {
            alert(
              `Error: ${
                xhr.responseJSON
                  ? xhr.responseJSON.message
                  : "An error occurred"
              }`
            );
          },
        });
      }

      function updateOrderCounts() {
        const activeOrdersCount = $(".order-card").length;
        const canceledOrdersCount = $(".canceled-order-list .order").length;
        $("#active-orders-count").text(activeOrdersCount);
        $("#canceled-orders-count").text(canceledOrdersCount);
      }

      $(document).ready(function () {
        // Cancel order click event
        $(".cancel-order").on("click", function (event) {
          event.preventDefault();
          const orderId = $(this).data("order-id");
          cancelOrder(orderId);
        });
      });

      function toggleDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById("userDropdown");
        dropdown.classList.toggle("show");
      }

      function confirmLogout() {
        const confirmation = confirm("Are you sure you want to log out?");
        if (confirmation) {
          window.location.href = "/logout";
        }
      }

      window.onclick = function (event) {
        const dropdown = document.getElementById("userDropdown");
        if (
          !event.target.matches(".user-icon") &&
          !event.target.closest(".dropdown-menu")
        ) {
          dropdown.classList.remove("show");
        }
      };

      function addToCart(productId) {
        const confirmation = confirm(
          "Are you sure you want to add this item to the cart?"
        );
        if (!confirmation) {
          return;
        }

        $.ajax({
          type: "POST",
          url: "/cart/add",
          data: { productId: productId },
          success: function (response) {
            const alertBox = $("#cartAlert");
            alertBox.text(response.message).fadeIn().delay(3000).fadeOut();
          },
          error: function (xhr) {
            const alertBox = $("#cartAlert");
            alertBox
              .text(
                `Error adding to cart: ${
                  xhr.responseJSON
                    ? xhr.responseJSON.message
                    : "An unexpected error occurred"
                }`
              )
              .fadeIn()
              .delay(3000)
              .fadeOut();
          },
        });
      }
    </script>
  </body>
</html>
